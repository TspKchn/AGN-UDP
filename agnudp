#!/usr/bin/env bash

CFG="/etc/hysteria/config.json"
DB="/etc/hysteria/users.db"

STATE="/etc/agnudp"
MODEFILE="$STATE/mode"
LASTSYNC="$STATE/last_sync"

BACKUP_DIR="/backup"
BACKUP_FILE="$BACKUP_DIR/agnudp-users.db.7z"
BACKUP_PORT="8080"

SERVICE="hysteria-server"
CRON_FILE="/etc/cron.d/agnudp"

mkdir -p "$STATE"

[[ ! -f "$MODEFILE" ]] && echo "manual" > "$MODEFILE"
MODE=$(cat "$MODEFILE")

AUTODELETE="ENABLED"
[[ "$MODE" != "manual" ]] && AUTODELETE="DISABLED"

LASTSYNC_TXT="-"
[[ -f "$LASTSYNC" ]] && LASTSYNC_TXT=$(cat "$LASTSYNC")

pause(){ read -rp "Press Enter to continue..."; }

header() {
  clear
  echo "======================================"
  echo "            AGN-UDP MANAGER            "
  echo "======================================"
  echo " Mode       : $MODE"
  echo " AutoDelete : $AUTODELETE"
  echo " Last Sync  : $LASTSYNC_TXT"
  echo "--------------------------------------"
}

update_cfg() {
  users=$(sqlite3 "$DB" \
    "select username||\":\"||password from users where date(expire)>=date('now')" \
    2>/dev/null)
  jq ".auth.config = $(printf '%s\n' "$users" | jq -R . | jq -s .)" \
    "$CFG" > /tmp/cfg && mv /tmp/cfg "$CFG"
  systemctl restart "$SERVICE" >/dev/null 2>&1 || true
}

# ================= USER =================
add_user() {
  read -rp "Username : " u
  read -rp "Password : " p
  read -rp "Days     : " d
  e=$(date -d "+$d days" +%F)
  sqlite3 "$DB" "insert or replace into users values('$u','$p','$e')"
  update_cfg
}

extend_user() {
  read -rp "Username : " u
  read -rp "Add days : " d
  cur=$(sqlite3 "$DB" "select expire from users where username='$u'")
  [[ -z "$cur" ]] && { echo "[x] User not found"; return; }
  new=$(date -d "$cur +$d days" +%F)
  sqlite3 "$DB" "update users set expire='$new' where username='$u'"
  update_cfg
}

delete_user() {
  read -rp "Username : " u
  sqlite3 "$DB" "delete from users where username='$u'"
  update_cfg
}

list_user() {
  echo
  sqlite3 "$DB" "select username || ' | ' || expire from users;"
}

# ================= BACKUP =================
backup_db() {
  read -rsp "Backup password: " p
  echo
  rm -f "$BACKUP_FILE"
  7z a -p"$p" -mhe=on "$BACKUP_FILE" "$DB" >/dev/null
  echo "[✓] Backup saved"
}

restore_db() {
  read -rp "Restore Server IP/Domain: " ip
  read -rsp "Backup password: " p
  echo

  tmp="/tmp/agnudp-restore"
  rm -rf "$tmp" && mkdir -p "$tmp"

  curl -fsSL \
    "http://$ip:$BACKUP_PORT/backup/$(basename $BACKUP_FILE)" \
    -o "$tmp/db.7z" || { echo "[x] Download failed"; return; }

  7z x -p"$p" "$tmp/db.7z" -o"$tmp" >/dev/null || {
    echo "[x] Wrong password"; return;
  }

  cp "$tmp/$(basename $DB)" "$DB"
  update_cfg
  echo "[✓] Restore completed"
}

# ================= SYNC =================
ssh_exec() {
  sshpass -p "$SSH_PASS" ssh \
    -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    -o LogLevel=QUIET \
    -o BatchMode=yes \
    -T -p "$SSH_PORT" "$SSH_USER@$SSH_HOST" "$1" 2>/dev/null
}

sync_import() {
  sqlite3 "$DB" "delete from users;"
  while IFS='|' read -r u e; do
    [[ -z "$u" || -z "$e" ]] && continue
    sqlite3 "$DB" "insert into users values('$u','$u','$e');"
  done <<< "$1"
  update_cfg
  date +"%F %T" > "$LASTSYNC"
}

sync_local() {
  echo "[*] Sync local..."
  DATA=$(sqlite3 "$DB" "select username,expire from users;")
  sync_import "$DATA"
  echo "manual" > "$MODEFILE"
  echo "[✓] Sync local done"
}

sync_remote() {
  read -rp "Remote IP/Domain: " SSH_HOST
  read -rp "SSH Port [22]: " SSH_PORT
  SSH_PORT=${SSH_PORT:-22}
  read -rp "SSH User: " SSH_USER
  read -rsp "SSH Password: " SSH_PASS
  echo

  echo "[*] Sync remote..."
  DATA=$(ssh_exec \
    "sqlite3 /etc/hysteria/users.db 'select username,expire from users;'")

  [[ -z "$DATA" ]] && { echo "[x] Sync failed"; return; }

  sync_import "$DATA"
  echo "sync:remote" > "$MODEFILE"
  echo "[✓] Sync remote done"
}

sync_3xui() {
  read -rp "3x-ui Server IP/Domain: " SSH_HOST
  read -rp "SSH Port [22]: " SSH_PORT
  SSH_PORT=${SSH_PORT:-22}
  read -rp "SSH User: " SSH_USER
  read -rsp "SSH Password: " SSH_PASS
  echo

  echo "[*] Sync 3x-ui..."
  DATA=$(ssh_exec \
    "sqlite3 /etc/x-ui/x-ui.db \"select email,expiry_time from client_traffics;\"")

  DATA=$(echo "$DATA" | awk -F'|' '{print $1 "|" strftime("%Y-%m-%d",$2/1000)}')
  [[ -z "$DATA" ]] && { echo "[x] Sync failed"; return; }

  sync_import "$DATA"
  echo "sync:3xui" > "$MODEFILE"
  echo "[✓] Sync 3x-ui done"
}

# ================= CLEANUP =================
cleanup_expired() {
  [[ "$AUTODELETE" != "ENABLED" ]] && {
    echo "[!] AutoDelete disabled (sync mode)"; return;
  }
  sqlite3 "$DB" "delete from users where date(expire)<date('now');"
  update_cfg
  echo "[✓] Cleanup completed"
}

# ================= UNINSTALL =================
uninstall_all() {
  clear
  echo "======================================"
  echo "      REMOVE AGN-UDP COMPLETELY        "
  echo "======================================"
  echo
  read -rp "Type YES to confirm: " c
  [[ "$c" != "YES" ]] && return

  set +e

  systemctl stop "$SERVICE" 2>/dev/null
  systemctl disable "$SERVICE" 2>/dev/null
  rm -f /etc/systemd/system/hysteria-server.service
  systemctl daemon-reload

  rm -f "$CRON_FILE"
  rm -rf /etc/hysteria /etc/agnudp /backup
  rm -f /usr/local/bin/agnudp

  IFACE=$(ip route | awk '/default/ {print $5; exit}')
  while iptables -t nat -C PREROUTING -i "$IFACE" -p udp --dport 10000:65000 -j DNAT --to :36712 2>/dev/null; do
    iptables -t nat -D PREROUTING -i "$IFACE" -p udp --dport 10000:65000 -j DNAT --to :36712
  done
  while iptables -C INPUT -p tcp --dport $BACKUP_PORT -j ACCEPT 2>/dev/null; do
    iptables -D INPUT -p tcp --dport $BACKUP_PORT -j ACCEPT
  done
  iptables-save > /etc/iptables/rules.v4

  echo
  echo "[✓] AGN-UDP UNINSTALLED COMPLETELY"
  sleep 2
  exit 0
}

# ================= MENU =================
while true; do
  header
  echo " 1) Add User"
  echo " 2) Extend User"
  echo " 3) Delete User"
  echo " 4) List Users"
  echo
  echo " 5) Backup"
  echo " 6) Restore"
  echo
  echo " 7) Sync Local"
  echo " 8) Sync Remote"
  echo " 9) Sync 3x-ui"
  echo
  echo "10) Cleanup Expired"
  echo "11) Uninstall AGN-UDP"
  echo
  echo " 0) Exit"
  echo "--------------------------------------"
  read -rp "Select: " c

  case $c in
    1) add_user ;;
    2) extend_user ;;
    3) delete_user ;;
    4) list_user ;;
    5) backup_db ;;
    6) restore_db ;;
    7) sync_local ;;
    8) sync_remote ;;
    9) sync_3xui ;;
    10) cleanup_expired ;;
    11) uninstall_all ;;
    0) exit 0 ;;
  esac
  pause
done
