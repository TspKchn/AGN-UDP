#!/usr/bin/env bash
set -Eeuo pipefail

CFG="/etc/hysteria/config.json"
DB="/etc/hysteria/users.db"

STATE="/etc/agnudp"
MODEFILE="$STATE/mode"
LASTSYNC="$STATE/last_sync"

BACKUP_DIR="/backup"
BACKUP_FILE="$BACKUP_DIR/agnudp-users.db.7z"

XUI_DB="/etc/x-ui/x-ui.db"

SERVICE="hysteria-server"

mkdir -p "$STATE"

[[ -f "$MODEFILE" ]] || echo "manual" > "$MODEFILE"
MODE=$(cat "$MODEFILE")

AUTODELETE="ENABLED"
[[ "$MODE" != "manual" ]] && AUTODELETE="DISABLED"

LASTSYNC_TXT="-"
[[ -f "$LASTSYNC" ]] && LASTSYNC_TXT=$(cat "$LASTSYNC")

pause(){ read -rp "Press Enter to continue..."; }

header() {
  clear
  echo "======================================"
  echo "           AGN-UDP MANAGER"
  echo "======================================"
  echo " Mode       : $MODE"
  echo " AutoDelete : $AUTODELETE"
  echo " Last Sync  : $LASTSYNC_TXT"
  echo "--------------------------------------"
}

update_cfg() {
  users=$(sqlite3 "$DB" "select username||\":\"||password from users where date(expire)>=date('now')" 2>/dev/null || true)
  jq ".auth.config = $(printf '%s\n' "$users" | jq -R . | jq -s .)" "$CFG" > /tmp/agnudp-cfg && mv /tmp/agnudp-cfg "$CFG"
  systemctl restart "$SERVICE" >/dev/null 2>&1 || true
}

### ================= USER =================
add_user() {
  read -rp "Username: " u
  read -rp "Password: " p
  read -rp "Days: " d
  e=$(date -d "+$d days" +%F)
  sqlite3 "$DB" "insert or replace into users values('$u','$p','$e');"
  update_cfg
}

extend_user() {
  read -rp "Username: " u
  read -rp "Add days: " d
  cur=$(sqlite3 "$DB" "select expire from users where username='$u'")
  new=$(date -d "$cur +$d days" +%F)
  sqlite3 "$DB" "update users set expire='$new' where username='$u';"
  update_cfg
}

delete_user() {
  read -rp "Username: " u
  sqlite3 "$DB" "delete from users where username='$u';"
  update_cfg
}

list_user() {
  sqlite3 "$DB" "select username || ' | ' || expire from users;"
}

### ================= BACKUP =================
backup_db() {
  read -rsp "Backup password: " p
  echo
  rm -f "$BACKUP_FILE"
  7z a -p"$p" -mhe=on "$BACKUP_FILE" "$DB" >/dev/null
  echo "[✓] Backup saved: $BACKUP_FILE"
}

restore_db() {
  read -rp "Remote IP/Domain: " host
  read -rsp "Backup password: " p
  echo
  tmp=/tmp/agnudp-restore
  rm -rf "$tmp" && mkdir -p "$tmp"
  curl -fsSL "http://$host:8080/backup/$(basename "$BACKUP_FILE")" -o "$tmp/db.7z" || {
    echo "❌ Download failed"; return; }
  7z x -p"$p" "$tmp/db.7z" -o"$tmp" >/dev/null || {
    echo "❌ Wrong password"; return; }
  cp "$tmp/$(basename "$DB")" "$DB"
  update_cfg
  echo "[✓] Restore completed"
}

### ================= SYNC CORE =================
sync_apply() {
  sqlite3 "$DB" "delete from users;"
  while IFS='|' read -r u e; do
    [[ -z "$u" ]] && continue
    sqlite3 "$DB" "insert into users values('$u','$u','$e');"
  done <<< "$1"
  update_cfg
  date +"%F %T" > "$LASTSYNC"
}

### ================= SYNC LOCAL =================
sync_local() {
  DATA=$(sqlite3 "$DB" "select username,expire from users;")
  sync_apply "$DATA"
  echo "manual" > "$MODEFILE"
  echo "[✓] Sync local completed"
}

### ================= SYNC WEBMIN =================
sync_webmin() {
  read -rp "Remote IP: " HOST
  read -rp "SSH Port [22]: " PORT
  PORT=${PORT:-22}
  read -rp "SSH User: " USER
  read -rsp "SSH Password: " PASS
  echo

  DATA=$(sshpass -p "$PASS" ssh -T \
    -o StrictHostKeyChecking=no \
    -o UserKnownHostsFile=/dev/null \
    -p "$PORT" "$USER@$HOST" '
      awk -F: "$3>=1000 && $3<65534 {print $1}" /etc/passwd |
      while read u; do
        exp=$(awk -F: -v user="$u" "$1==user {print $8}" /etc/shadow)
        if [ -z "$exp" ]; then
          echo "$u|2099-12-31"
        else
          date -d "1970-01-01 +$exp days" "+$u|%Y-%m-%d"
        fi
      done
    ')

  [[ -z "$DATA" ]] && { echo "❌ Sync webmin failed"; return; }

  sync_apply "$DATA"
  echo "sync:webmin" > "$MODEFILE"
  echo "[✓] Sync webmin completed"
}

### ================= SYNC X-UI =================
sync_xui() {
  read -rp "Remote IP: " HOST
  read -rp "SSH Port [22]: " PORT
  PORT=${PORT:-22}
  read -rp "SSH User: " USER
  read -rsp "SSH Password: " PASS
  echo

  DATA=$(sshpass -p "$PASS" ssh -T -o StrictHostKeyChecking=no -p "$PORT" "$USER@$HOST" \
    "sqlite3 $XUI_DB \"select email,expiry_time from client_traffics;\"" \
    | awk -F'|' '{print $1\"|\"strftime(\"%Y-%m-%d\",\$2/1000)}')

  [[ -z "$DATA" ]] && { echo "❌ Sync failed"; return; }

  sync_apply "$DATA"
  echo "sync:xui" > "$MODEFILE"
  echo "[✓] Sync x-ui completed"
}

### ================= CLEANUP =================
cleanup_expired() {
  [[ "$AUTODELETE" != "ENABLED" ]] && return
  sqlite3 "$DB" "delete from users where date(expire)<date('now');"
  update_cfg
  echo "[✓] Cleanup completed"
}

### ================= MENU =================
while true; do
  header
  echo " 1) Add User"
  echo " 2) Extend User"
  echo " 3) Delete User"
  echo " 4) List Users"
  echo
  echo " 5) Backup"
  echo " 6) Restore"
  echo
  echo " 7) Sync Local"
  echo " 8) Sync Webmin"
  echo " 9) Sync x-ui"
  echo
  echo "10) Cleanup Expired"
  echo
  echo " 0) Exit"
  echo "--------------------------------------"
  read -rp "Select: " c

  case "$c" in
    1) add_user ;;
    2) extend_user ;;
    3) delete_user ;;
    4) list_user ;;
    5) backup_db ;;
    6) restore_db ;;
    7) sync_local ;;
    8) sync_webmin ;;
    9) sync_xui ;;
    10) cleanup_expired ;;
    0) exit ;;
  esac
  pause
done
